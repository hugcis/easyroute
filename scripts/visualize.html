<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EasyRoute Visualizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            max-width: 320px;
            max-height: calc(100vh - 20px);
            overflow-y: auto;
            z-index: 1;
        }

        .api-input {
            width: 100%;
            min-height: 100px;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        button {
            background: #4264fb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
        }

        button:hover {
            background: #3451cc;
        }

        .route-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 13px;
        }

        .route-item {
            padding: 8px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 3px;
            cursor: pointer;
        }

        .route-item:hover {
            background: #e5e5e5;
        }

        .route-item.selected {
            background: #4264fb;
            color: white;
        }

        .poi-marker {
            background-color: #4264fb;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .snapped-poi-marker {
            background-color: #ff9500;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .start-marker {
            background-color: #00D084;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 13px;
            color: #666;
            border-radius: 0;
        }

        .tab.active {
            color: #4264fb;
            border-bottom: 2px solid #4264fb;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .checkbox-group {
            margin-top: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: normal;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 6px;
        }

        .coord-button {
            padding: 4px 8px;
            font-size: 11px;
            background: #28a745;
            margin-top: 4px;
            width: auto;
            display: inline-block;
        }

        .coord-button:hover {
            background: #218838;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 10px;
        }

        /* Map center crosshair */
        .map-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 20px;
            background: #28a745;
            margin-left: -1px;
            margin-top: -10px;
            pointer-events: none;
            z-index: 2;
            opacity: 0.6;
        }

        .map-crosshair::before {
            content: '';
            position: absolute;
            left: -9px;
            top: 9px;
            width: 20px;
            height: 2px;
            background: #28a745;
        }

        .map-crosshair::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 4px;
            width: 10px;
            height: 10px;
            border: 2px solid #28a745;
            border-radius: 50%;
            background: rgba(40, 167, 69, 0.2);
        }

        .map-center-display {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 11px;
            font-family: monospace;
            z-index: 2;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="map">
    <div class="map-crosshair"></div>
    <div class="map-center-display" id="mapCenterDisplay">
        Lat: 48.8566, Lng: 2.3522
    </div>
</div>

<div class="controls">
    <h3 style="margin-top: 0;">EasyRoute Tester</h3>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('generate')">Generate Route</button>
        <button class="tab" onclick="switchTab('paste')">Paste JSON</button>
    </div>

    <!-- Generate Route Tab -->
    <div id="generateTab" class="tab-content active">
        <div class="form-group">
            <label>API Endpoint</label>
            <input type="text" id="apiEndpoint" value="http://localhost:3000" placeholder="http://localhost:3000">
        </div>

        <div class="form-group">
            <label>Route Type</label>
            <select id="routeType" onchange="updateRouteTypeFields()">
                <option value="loop">Loop Route</option>
                <option value="point-to-point">Point-to-Point</option>
            </select>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Start Latitude</label>
                <input type="number" id="startLat" value="48.8566" step="0.0001" placeholder="48.8566">
            </div>
            <div class="form-group">
                <label>Start Longitude</label>
                <input type="number" id="startLng" value="2.3522" step="0.0001" placeholder="2.3522">
            </div>
        </div>
        <button class="coord-button" onclick="setStartFromMapCenter()">üìç Use Map Center</button>

        <div id="endPointFields" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label>End Latitude</label>
                    <input type="number" id="endLat" value="48.8606" step="0.0001" placeholder="48.8606">
                </div>
                <div class="form-group">
                    <label>End Longitude</label>
                    <input type="number" id="endLng" value="2.3376" step="0.0001" placeholder="2.3376">
                </div>
            </div>
            <button class="coord-button" onclick="setEndFromMapCenter()">üìç Use Map Center</button>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Distance (km)</label>
                <input type="number" id="distance" value="5.0" step="0.5" min="0.5" max="50" placeholder="5.0">
            </div>
            <div class="form-group">
                <label>Mode</label>
                <select id="mode">
                    <option value="walk">Walking</option>
                    <option value="bike">Cycling</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>POI Categories (optional)</label>
            <div class="checkbox-group">
                <label><input type="checkbox" value="monument"> Monuments</label>
                <label><input type="checkbox" value="park"> Parks</label>
                <label><input type="checkbox" value="museum"> Museums</label>
                <label><input type="checkbox" value="viewpoint"> Viewpoints</label>
                <label><input type="checkbox" value="historic"> Historic Sites</label>
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <label><input type="checkbox" id="hiddenGems"> Prefer Hidden Gems</label>
            </div>
        </div>

        <button onclick="generateRoute()" id="generateBtn">Generate Route</button>
        <div id="errorMsg" style="display: none;"></div>
    </div>

    <!-- Paste JSON Tab -->
    <div id="pasteTab" class="tab-content">
        <p style="font-size: 12px; color: #666; margin-top: 0;">Paste API response JSON below:</p>
        <textarea class="api-input" id="apiResponse" placeholder='{"routes": [...]}'></textarea>
        <button onclick="visualizeRoutes()">Visualize Routes</button>
    </div>

    <div style="margin-bottom: 10px;">
        <button id="coverageBtn" onclick="toggleCoverage()" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">Show Coverage</button>
    </div>

    <div id="routeInfo" class="route-info" style="display: none;"></div>
</div>

<script>
    // Initialize map - REPLACE 'YOUR_MAPBOX_TOKEN' with your actual token
    mapboxgl.accessToken = 'pk.eyJ1IjoiaHVnY2lzIiwiYSI6ImNsZ2Znd3Y5NDAxbTUzb3QxMDg4ZWlkY24ifQ.nQ6tVINow8RIuaiPkTReBQ';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [2.3522, 48.8566], // Paris default
        zoom: 12
    });

    map.addControl(new mapboxgl.NavigationControl());

    let currentMarkers = [];
    let currentRoutes = null;
    let selectedRouteIndex = 0;

    // Update map center display when map moves
    function updateMapCenterDisplay() {
        const center = map.getCenter();
        document.getElementById('mapCenterDisplay').textContent =
            `Lat: ${center.lat.toFixed(4)}, Lng: ${center.lng.toFixed(4)}`;
    }

    // Update on map move
    map.on('move', updateMapCenterDisplay);

    // Initial update
    updateMapCenterDisplay();

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Update tab content
        document.getElementById('generateTab').classList.remove('active');
        document.getElementById('pasteTab').classList.remove('active');

        if (tabName === 'generate') {
            document.getElementById('generateTab').classList.add('active');
        } else {
            document.getElementById('pasteTab').classList.add('active');
        }
    }

    // Update form fields based on route type
    function updateRouteTypeFields() {
        const routeType = document.getElementById('routeType').value;
        const endPointFields = document.getElementById('endPointFields');

        if (routeType === 'point-to-point') {
            endPointFields.style.display = 'block';
        } else {
            endPointFields.style.display = 'none';
        }
    }

    // Set start coordinates from current map center
    function setStartFromMapCenter() {
        const center = map.getCenter();
        document.getElementById('startLat').value = center.lat.toFixed(4);
        document.getElementById('startLng').value = center.lng.toFixed(4);

        // Visual feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Updated!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 1000);
    }

    // Set end coordinates from current map center
    function setEndFromMapCenter() {
        const center = map.getCenter();
        document.getElementById('endLat').value = center.lat.toFixed(4);
        document.getElementById('endLng').value = center.lng.toFixed(4);

        // Visual feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Updated!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 1000);
    }

    // Generate route by calling the API
    async function generateRoute() {
        const btn = document.getElementById('generateBtn');
        const errorMsg = document.getElementById('errorMsg');
        const controls = document.querySelector('.controls');

        // Clear previous errors
        errorMsg.style.display = 'none';
        errorMsg.className = '';

        // Show loading state
        btn.disabled = true;
        btn.textContent = 'Generating...';
        controls.classList.add('loading');

        try {
            // Get form values
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const routeType = document.getElementById('routeType').value;
            const startLat = parseFloat(document.getElementById('startLat').value);
            const startLng = parseFloat(document.getElementById('startLng').value);
            const distance = parseFloat(document.getElementById('distance').value);
            const mode = document.getElementById('mode').value;

            // Validate inputs
            if (!apiEndpoint) throw new Error('API endpoint is required');
            if (isNaN(startLat) || isNaN(startLng)) throw new Error('Invalid start coordinates');
            if (isNaN(distance) || distance <= 0) throw new Error('Invalid distance');

            // Build request body
            const requestBody = {
                start_point: {
                    lat: startLat,
                    lng: startLng
                },
                distance_km: distance,
                mode: mode
            };

            // Add end point for point-to-point routes
            if (routeType === 'point-to-point') {
                const endLat = parseFloat(document.getElementById('endLat').value);
                const endLng = parseFloat(document.getElementById('endLng').value);
                if (isNaN(endLat) || isNaN(endLng)) throw new Error('Invalid end coordinates');
                requestBody.end_point = {
                    lat: endLat,
                    lng: endLng
                };
            }

            // Add preferences
            const preferences = {};

            // Get selected POI categories
            const selectedCategories = [];
            document.querySelectorAll('.checkbox-group input[type="checkbox"][value]').forEach(cb => {
                if (cb.checked) selectedCategories.push(cb.value);
            });
            if (selectedCategories.length > 0) {
                preferences.poi_categories = selectedCategories;
            }

            // Hidden gems preference
            if (document.getElementById('hiddenGems').checked) {
                preferences.hidden_gems = true;
            }

            if (Object.keys(preferences).length > 0) {
                requestBody.preferences = preferences;
            }

            // Determine API endpoint
            const endpoint = routeType === 'loop' ? '/api/v1/routes/loop' : '/api/v1/routes/point-to-point';
            const url = `${apiEndpoint}${endpoint}`;

            console.log('Calling API:', url, requestBody);

            // Call the API
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API error (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            console.log('API response:', data);

            // Visualize the routes
            currentRoutes = data.routes;

            if (!currentRoutes || currentRoutes.length === 0) {
                throw new Error('No routes returned from API');
            }

            // Show route info panel
            displayRouteInfo();

            // Display first route
            displayRoute(0);

            // Success message
            errorMsg.className = '';
            errorMsg.style.display = 'none';

        } catch (error) {
            console.error('Error:', error);
            errorMsg.className = 'error';
            errorMsg.textContent = error.message;
            errorMsg.style.display = 'block';
        } finally {
            // Reset button state
            btn.disabled = false;
            btn.textContent = 'Generate Route';
            controls.classList.remove('loading');
        }
    }

    function visualizeRoutes() {
        const input = document.getElementById('apiResponse').value;

        try {
            const data = JSON.parse(input);
            currentRoutes = data.routes;

            if (!currentRoutes || currentRoutes.length === 0) {
                alert('No routes found in response');
                return;
            }

            // Show route info panel
            displayRouteInfo();

            // Display first route
            displayRoute(0);

        } catch (e) {
            alert('Invalid JSON: ' + e.message);
        }
    }

    function displayRouteInfo() {
        const infoDiv = document.getElementById('routeInfo');
        infoDiv.style.display = 'block';

        let html = '<h4 style="margin: 0 0 10px 0;">Routes:</h4>';
        currentRoutes.forEach((route, idx) => {
            const selected = idx === selectedRouteIndex ? 'selected' : '';
            html += `
                <div class="route-item ${selected}" onclick="displayRoute(${idx})">
                    <strong>Route ${idx + 1}</strong><br>
                    ${route.distance_km.toFixed(1)} km ¬∑
                    ${route.estimated_duration_minutes} min ¬∑
                    Score: ${route.score.toFixed(1)}/10<br>
                    ${route.pois.length} waypoint POIs
                    ${route.snapped_pois ? ` ¬∑ ${route.snapped_pois.length} nearby POIs` : ''}
                </div>
            `;
        });
        infoDiv.innerHTML = html;
    }

    function displayRoute(index) {
        selectedRouteIndex = index;
        const route = currentRoutes[index];

        // Clear existing markers and layers
        clearMap();

        // Convert path to GeoJSON LineString (Mapbox uses [lng, lat])
        const lineCoordinates = route.path.map(coord => [coord.lng, coord.lat]);

        // Add route line
        if (map.getSource('route')) {
            map.getSource('route').setData({
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: lineCoordinates
                }
            });
        } else {
            map.addSource('route', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: lineCoordinates
                    }
                }
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#4264fb',
                    'line-width': 4
                }
            });
        }

        // Add start/end marker
        const startCoord = route.path[0];
        const startEl = document.createElement('div');
        startEl.className = 'start-marker';

        const startMarker = new mapboxgl.Marker(startEl)
            .setLngLat([startCoord.lng, startCoord.lat])
            .setPopup(new mapboxgl.Popup().setHTML('<strong>Start/End</strong>'))
            .addTo(map);
        currentMarkers.push(startMarker);

        // Add waypoint POI markers
        route.pois.forEach((poi, idx) => {
            const el = document.createElement('div');
            el.className = 'poi-marker';
            el.textContent = poi.order_in_route;

            const popupHTML = `
                <strong>${poi.name}</strong> (Waypoint)<br>
                Category: ${poi.category}<br>
                Popularity: ${poi.popularity_score.toFixed(0)}/100<br>
                ${poi.description ? poi.description + '<br>' : ''}
                Distance from start: ${poi.distance_from_start_km.toFixed(1)} km
            `;

            const marker = new mapboxgl.Marker(el)
                .setLngLat([poi.coordinates.lng, poi.coordinates.lat])
                .setPopup(new mapboxgl.Popup().setHTML(popupHTML))
                .addTo(map);

            currentMarkers.push(marker);
        });

        // Add snapped POI markers (nearby but not waypoints)
        if (route.snapped_pois) {
            route.snapped_pois.forEach((poi, idx) => {
                const el = document.createElement('div');
                el.className = 'snapped-poi-marker';

                const popupHTML = `
                    <strong>${poi.name}</strong> (Nearby)<br>
                    Category: ${poi.category}<br>
                    Popularity: ${poi.popularity_score.toFixed(0)}/100<br>
                    ${poi.description ? poi.description + '<br>' : ''}
                    Distance from path: ${poi.distance_from_path_m.toFixed(0)}m<br>
                    Distance along route: ${poi.distance_from_start_km.toFixed(1)} km
                `;

                const marker = new mapboxgl.Marker(el)
                    .setLngLat([poi.coordinates.lng, poi.coordinates.lat])
                    .setPopup(new mapboxgl.Popup().setHTML(popupHTML))
                    .addTo(map);

                currentMarkers.push(marker);
            });
        }

        // Fit map to route bounds
        const bounds = new mapboxgl.LngLatBounds();
        lineCoordinates.forEach(coord => bounds.extend(coord));
        map.fitBounds(bounds, { padding: 50 });

        // Update UI
        displayRouteInfo();
    }

    function clearMap() {
        // Remove markers
        currentMarkers.forEach(marker => marker.remove());
        currentMarkers = [];
    }

    // Example data (for testing without API)
    const exampleData = {
        "routes": [{
            "id": "example",
            "distance_km": 5.2,
            "estimated_duration_minutes": 78,
            "path": [
                {"lat": 48.8566, "lng": 2.3522},
                {"lat": 48.8584, "lng": 2.2945},
                {"lat": 48.8556, "lng": 2.2986},
                {"lat": 48.8566, "lng": 2.3522}
            ],
            "pois": [
                {
                    "name": "Eiffel Tower",
                    "category": "monument",
                    "coordinates": {"lat": 48.8584, "lng": 2.2945},
                    "popularity_score": 95,
                    "order_in_route": 1,
                    "distance_from_start_km": 1.7,
                    "description": "Iconic iron tower"
                }
            ],
            "score": 8.5
        }]
    };

    // Auto-load example on page load (remove in production)
    // document.getElementById('apiResponse').value = JSON.stringify(exampleData, null, 2);

    // Coverage overlay
    let coverageVisible = false;

    async function toggleCoverage() {
        const btn = document.getElementById('coverageBtn');

        if (coverageVisible) {
            // Remove coverage layer
            if (map.getLayer('coverage-fill')) map.removeLayer('coverage-fill');
            if (map.getLayer('coverage-outline')) map.removeLayer('coverage-outline');
            if (map.getSource('coverage')) map.removeSource('coverage');
            coverageVisible = false;
            btn.textContent = 'Show Coverage';
            btn.style.background = '#6c757d';
            return;
        }

        btn.textContent = 'Loading...';
        btn.disabled = true;

        try {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const response = await fetch(`${apiEndpoint}/api/v1/debug/coverage`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);
            if (!data.coverage) throw new Error('No POI data available');

            const geojson = {
                type: 'Feature',
                geometry: data.coverage
            };

            if (map.getSource('coverage')) {
                map.getSource('coverage').setData(geojson);
            } else {
                map.addSource('coverage', { type: 'geojson', data: geojson });
            }

            if (!map.getLayer('coverage-fill')) {
                map.addLayer({
                    id: 'coverage-fill',
                    type: 'fill',
                    source: 'coverage',
                    paint: {
                        'fill-color': 'rgba(66, 100, 251, 0.1)',
                        'fill-outline-color': 'rgba(66, 100, 251, 0.4)'
                    }
                });
            }

            if (!map.getLayer('coverage-outline')) {
                map.addLayer({
                    id: 'coverage-outline',
                    type: 'line',
                    source: 'coverage',
                    paint: {
                        'line-color': 'rgba(66, 100, 251, 0.6)',
                        'line-width': 2,
                        'line-dasharray': [4, 2]
                    }
                });
            }

            // Fit bounds to coverage area
            const bounds = new mapboxgl.LngLatBounds();
            const geom = data.coverage;
            if (geom.type === 'Polygon') {
                geom.coordinates[0].forEach(c => bounds.extend(c));
            } else if (geom.type === 'MultiPolygon') {
                geom.coordinates.forEach(poly => poly[0].forEach(c => bounds.extend(c)));
            }
            map.fitBounds(bounds, { padding: 50 });

            coverageVisible = true;
            const clusters = data.cluster_count || '?';
            btn.textContent = `Hide Coverage (${data.poi_count} POIs, ${clusters} regions)`;
            btn.style.background = '#4264fb';

        } catch (error) {
            console.error('Coverage error:', error);
            alert('Failed to load coverage: ' + error.message);
            btn.textContent = 'Show Coverage';
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
