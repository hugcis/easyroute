services:
  postgres:
    image: postgis/postgis:18-3.6
    platform: linux/amd64
    container_name: easyroute_postgres
    environment:
      POSTGRES_DB: easyroute
      POSTGRES_USER: easyroute_user
      POSTGRES_PASSWORD: easyroute_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U easyroute_user -d easyroute"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8.4-alpine
    container_name: easyroute_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # osm2pgsql for importing OSM data
  # This is not a long-running service, but a tool container
  # Use it with: docker-compose run --rm osm2pgsql <args>
  osm2pgsql:
    image: ghcr.io/openstreetmap/osm2pgsql:latest
    container_name: easyroute_osm2pgsql
    profiles: ["tools"]  # Only start when explicitly requested
    depends_on:
      - postgres
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: easyroute
      PGUSER: easyroute_user
      PGPASSWORD: easyroute_pass
    volumes:
      - ./osm/data:/data:ro          # OSM data files
      - ./osm:/osm:ro                # Style and config files
    network_mode: "host"

volumes:
  postgres_data:
  redis_data:
